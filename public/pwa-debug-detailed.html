<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic PWA D√©taill√© - HatCast</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: rgba(34, 197, 94, 0.3); border: 1px solid #22c55e; }
        .error { background: rgba(239, 68, 68, 0.3); border: 1px solid #ef4444; }
        .warning { background: rgba(245, 158, 11, 0.3); border: 1px solid #f59e0b; }
        .info { background: rgba(59, 130, 246, 0.3); border: 1px solid #3b82f6; }
        
        .criteria {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        button {
            background: #22c55e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
        }
        
        .user-agent {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic PWA D√©taill√© - HatCast</h1>
        
        <div id="summary"></div>
        
        <div class="criteria">
            <h3>üìã Crit√®res d'√©ligibilit√© Chrome PWA</h3>
            <div id="criteria"></div>
        </div>
        
        <div>
            <button onclick="runFullDiagnostic()">üîç Diagnostic complet</button>
            <button onclick="checkInstallability()">üì± V√©rifier installabilit√©</button>
            <button onclick="clearLog()">üóëÔ∏è Effacer les logs</button>
            <button onclick="location.reload()">üîÑ Recharger</button>
        </div>
        
        <div class="log" id="log"></div>
        
        <div class="user-agent" id="userAgent"></div>
    </div>

    <script>
        let deferredPrompt = null;
        const summaryDiv = document.getElementById('summary');
        const criteriaDiv = document.getElementById('criteria');
        const logDiv = document.getElementById('log');
        const userAgentDiv = document.getElementById('userAgent');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #9ca3af;">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        function updateSummary(message, type) {
            summaryDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function updateCriteria(criteria) {
            criteriaDiv.innerHTML = criteria;
        }
        
        // Afficher User Agent
        function showUserAgent() {
            const ua = navigator.userAgent;
            userAgentDiv.innerHTML = `<strong>User Agent:</strong> ${ua}`;
            
            // D√©tecter Chrome Mobile
            const isChromeMobile = /Chrome/.test(ua) && /Mobile/.test(ua);
            const isAndroid = /Android/.test(ua);
            
            log(`üåê User Agent: ${ua}`);
            log(`üì± Chrome Mobile: ${isChromeMobile ? '‚úÖ Oui' : '‚ùå Non'}`);
            log(`ü§ñ Android: ${isAndroid ? '‚úÖ Oui' : '‚ùå Non'}`);
        }
        
        // V√©rifier les crit√®res d'√©ligibilit√© Chrome
        async function checkChromeCriteria() {
            log('üîç V√©rification des crit√®res Chrome PWA...');
            
            let criteria = '';
            let allPassed = true;
            
            // 1. HTTPS
            if (location.protocol === 'https:') {
                criteria += '<div class="status success">‚úÖ HTTPS actif</div>';
                log('‚úÖ HTTPS actif');
            } else {
                criteria += '<div class="status error">‚ùå HTTPS requis</div>';
                log('‚ùå HTTPS requis pour PWA');
                allPassed = false;
            }
            
            // 2. Manifest valide
            try {
                const manifestResponse = await fetch('/manifest.webmanifest');
                if (manifestResponse.ok) {
                    const manifest = await manifestResponse.json();
                    criteria += '<div class="status success">‚úÖ Manifest accessible et valide</div>';
                    log('‚úÖ Manifest accessible et valide');
                    
                    // V√©rifier les propri√©t√©s requises
                    const required = ['name', 'short_name', 'start_url', 'display', 'icons'];
                    const missing = required.filter(prop => !manifest[prop]);
                    
                    if (missing.length === 0) {
                        criteria += '<div class="status success">‚úÖ Toutes les propri√©t√©s requises pr√©sentes</div>';
                        log('‚úÖ Toutes les propri√©t√©s requises pr√©sentes');
                    } else {
                        criteria += `<div class="status error">‚ùå Propri√©t√©s manquantes: ${missing.join(', ')}</div>`;
                        log(`‚ùå Propri√©t√©s manquantes: ${missing.join(', ')}`);
                        allPassed = false;
                    }
                    
                    // V√©rifier les ic√¥nes
                    if (manifest.icons && manifest.icons.length > 0) {
                        const has192 = manifest.icons.some(icon => icon.sizes === '192x192' && icon.purpose && icon.purpose.includes('any'));
                        const has512 = manifest.icons.some(icon => icon.sizes === '512x512' && icon.purpose && icon.purpose.includes('any'));
                        
                        if (has192 && has512) {
                            criteria += '<div class="status success">‚úÖ Ic√¥nes 192x192 et 512x512 pr√©sentes</div>';
                            log('‚úÖ Ic√¥nes 192x192 et 512x512 pr√©sentes');
                        } else {
                            criteria += '<div class="status error">‚ùå Ic√¥nes 192x192 et 512x512 requises</div>';
                            log('‚ùå Ic√¥nes 192x192 et 512x512 requises');
                            allPassed = false;
                        }
                    } else {
                        criteria += '<div class="status error">‚ùå Aucune ic√¥ne d√©finie</div>';
                        log('‚ùå Aucune ic√¥ne d√©finie');
                        allPassed = false;
                    }
                    
                    // V√©rifier display standalone
                    if (manifest.display === 'standalone') {
                        criteria += '<div class="status success">‚úÖ Display standalone</div>';
                        log('‚úÖ Display standalone');
                    } else {
                        criteria += '<div class="status error">‚ùå Display standalone requis</div>';
                        log('‚ùå Display standalone requis');
                        allPassed = false;
                    }
                } else {
                    criteria += '<div class="status error">‚ùå Manifest non accessible</div>';
                    log('‚ùå Manifest non accessible');
                    allPassed = false;
                }
            } catch (error) {
                criteria += '<div class="status error">‚ùå Erreur manifest</div>';
                log(`‚ùå Erreur manifest: ${error.message}`);
                allPassed = false;
            }
            
            // 3. Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        criteria += '<div class="status success">‚úÖ Service Worker enregistr√©</div>';
                        log('‚úÖ Service Worker enregistr√©');
                    } else {
                        criteria += '<div class="status error">‚ùå Service Worker non enregistr√©</div>';
                        log('‚ùå Service Worker non enregistr√©');
                        allPassed = false;
                    }
                } catch (error) {
                    criteria += '<div class="status error">‚ùå Erreur Service Worker</div>';
                    log(`‚ùå Erreur Service Worker: ${error.message}`);
                    allPassed = false;
                }
            } else {
                criteria += '<div class="status error">‚ùå Service Worker non support√©</div>';
                log('‚ùå Service Worker non support√©');
                allPassed = false;
            }
            
            // 4. Navigation engagement
            const engagement = await checkEngagement();
            if (engagement) {
                criteria += '<div class="status success">‚úÖ Engagement utilisateur suffisant</div>';
                log('‚úÖ Engagement utilisateur suffisant');
            } else {
                criteria += '<div class="status warning">‚ö†Ô∏è Engagement utilisateur insuffisant (peut prendre du temps)</div>';
                log('‚ö†Ô∏è Engagement utilisateur insuffisant (peut prendre du temps)');
            }
            
            updateCriteria(criteria);
            return allPassed;
        }
        
        // V√©rifier l'engagement utilisateur
        async function checkEngagement() {
            // Chrome v√©rifie l'engagement utilisateur (visites r√©p√©t√©es, temps pass√©, etc.)
            // On ne peut pas le mesurer directement, mais on peut donner des conseils
            log('üìä V√©rification de l\'engagement utilisateur...');
            
            // V√©rifier si c'est la premi√®re visite
            const visitCount = localStorage.getItem('hatcast-visit-count') || 0;
            const newCount = parseInt(visitCount) + 1;
            localStorage.setItem('hatcast-visit-count', newCount);
            
            log(`üìà Nombre de visites: ${newCount}`);
            
            if (newCount >= 3) {
                return true;
            } else {
                log(`üí° Conseil: Visitez cette page ${3 - newCount} fois de plus pour am√©liorer l'√©ligibilit√©`);
                return false;
            }
        }
        
        // V√©rifier l'installabilit√©
        function checkInstallability() {
            log('üì± V√©rification de l\'installabilit√©...');
            
            if (deferredPrompt) {
                log('üéâ √âv√©nement beforeinstallprompt disponible !');
                updateSummary('üéâ Installation PWA disponible !', 'success');
            } else {
                log('‚ùå √âv√©nement beforeinstallprompt non disponible');
                updateSummary('‚ùå Installation PWA non disponible - V√©rifiez les crit√®res ci-dessus', 'error');
            }
            
            // V√©rifier si d√©j√† install√©
            if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
                log('üì± Application d√©j√† install√©e en mode standalone');
                updateSummary('üì± Application d√©j√† install√©e', 'info');
            }
        }
        
        // Diagnostic complet
        async function runFullDiagnostic() {
            clearLog();
            log('üöÄ D√©marrage du diagnostic complet...');
            
            showUserAgent();
            
            const criteriaPassed = await checkChromeCriteria();
            
            if (criteriaPassed) {
                log('‚úÖ Tous les crit√®res techniques sont satisfaits');
                updateSummary('‚úÖ Crit√®res techniques satisfaits - L\'installation devrait √™tre possible', 'success');
            } else {
                log('‚ùå Certains crit√®res ne sont pas satisfaits');
                updateSummary('‚ùå Crit√®res techniques non satisfaits - Corrigez les erreurs ci-dessus', 'error');
            }
            
            checkInstallability();
        }
        
        // √âcouter l'√©v√©nement beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            log('üéâ √âV√âNEMENT BEFOREINSTALLPROMPT D√âCLENCH√â !');
            
            e.preventDefault();
            deferredPrompt = e;
            
            updateSummary('üéâ Installation PWA disponible !', 'success');
            checkInstallability();
        });
        
        // √âv√©nement quand l'app est install√©e
        window.addEventListener('appinstalled', (evt) => {
            log('‚úÖ Application install√©e avec succ√®s !');
            updateSummary('‚úÖ Application install√©e !', 'success');
            deferredPrompt = null;
        });
        
        // Initialisation
        window.addEventListener('load', () => {
            log('üöÄ Diagnostic PWA initialis√©');
            showUserAgent();
            runFullDiagnostic();
        });
        
        // Log des erreurs
        window.addEventListener('error', (e) => {
            log(`‚ùå Erreur: ${e.message}`, 'error');
        });
    </script>
</body>
</html>
