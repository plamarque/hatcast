<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Installation PWA - HatCast</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: rgba(34, 197, 94, 0.3); border: 1px solid #22c55e; }
        .error { background: rgba(239, 68, 68, 0.3); border: 1px solid #ef4444; }
        .warning { background: rgba(245, 158, 11, 0.3); border: 1px solid #f59e0b; }
        .info { background: rgba(59, 130, 246, 0.3); border: 1px solid #3b82f6; }
        
        button {
            background: #22c55e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Installation PWA HatCast</h1>
        
        <div id="status"></div>
        
        <div>
            <button onclick="testInstall()" id="installBtn" disabled>üì± Installer l'app</button>
            <button onclick="clearLog()">üóëÔ∏è Effacer les logs</button>
            <button onclick="location.reload()">üîÑ Recharger</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let deferredPrompt = null;
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const installBtn = document.getElementById('installBtn');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #9ca3af;">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type) {
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        // V√©rifier les crit√®res PWA
        function checkPWACriteria() {
            log('üîç V√©rification des crit√®res PWA...');
            
            // 1. HTTPS
            if (location.protocol === 'https:') {
                log('‚úÖ HTTPS actif');
            } else {
                log('‚ùå HTTPS requis pour PWA');
                return false;
            }
            
            // 2. Service Worker
            if ('serviceWorker' in navigator) {
                log('‚úÖ Service Worker support√©');
            } else {
                log('‚ùå Service Worker non support√©');
                return false;
            }
            
            // 3. Manifest
            fetch('/manifest.webmanifest')
                .then(response => {
                    if (response.ok) {
                        log('‚úÖ Manifest accessible');
                        return response.json();
                    } else {
                        log('‚ùå Manifest non accessible');
                        return null;
                    }
                })
                .then(manifest => {
                    if (manifest) {
                        log(`‚úÖ Manifest valide: ${manifest.name}`);
                        
                        // V√©rifier les propri√©t√©s requises
                        const required = ['name', 'short_name', 'start_url', 'display', 'icons'];
                        required.forEach(prop => {
                            if (manifest[prop]) {
                                log(`‚úÖ Propri√©t√© ${prop} pr√©sente`);
                            } else {
                                log(`‚ùå Propri√©t√© ${prop} manquante`);
                            }
                        });
                    }
                })
                .catch(error => {
                    log(`‚ùå Erreur manifest: ${error.message}`);
                });
            
            return true;
        }
        
        // √âcouter l'√©v√©nement beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            log('üéâ √âv√©nement beforeinstallprompt d√©clench√© !');
            
            // Emp√™cher l'affichage automatique
            e.preventDefault();
            
            // Stocker l'√©v√©nement
            deferredPrompt = e;
            
            // Activer le bouton d'installation
            installBtn.disabled = false;
            installBtn.textContent = 'üì± Installer l\'app (disponible)';
            
            updateStatus('üéâ Installation PWA disponible ! Cliquez sur le bouton pour installer.', 'success');
        });
        
        // √âv√©nement quand l'app est install√©e
        window.addEventListener('appinstalled', (evt) => {
            log('‚úÖ Application install√©e avec succ√®s !');
            updateStatus('‚úÖ Application install√©e !', 'success');
            deferredPrompt = null;
            installBtn.disabled = true;
            installBtn.textContent = '‚úÖ App install√©e';
        });
        
        // V√©rifier si d√©j√† install√©
        if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
            log('üì± Application d√©j√† install√©e en mode standalone');
            updateStatus('üì± Application d√©j√† install√©e', 'info');
        }
        
        // Fonction d'installation
        async function testInstall() {
            if (!deferredPrompt) {
                log('‚ùå Aucun prompt d\'installation disponible');
                updateStatus('‚ùå Installation non disponible', 'error');
                return;
            }
            
            log('üöÄ D√©clenchement de l\'installation...');
            
            try {
                // Afficher le prompt d'installation
                deferredPrompt.prompt();
                
                // Attendre la r√©ponse de l'utilisateur
                const choiceResult = await deferredPrompt.userChoice;
                
                if (choiceResult.outcome === 'accepted') {
                    log('‚úÖ Utilisateur a accept√© l\'installation');
                    updateStatus('‚úÖ Installation accept√©e !', 'success');
                } else {
                    log('‚ùå Utilisateur a refus√© l\'installation');
                    updateStatus('‚ùå Installation refus√©e', 'warning');
                }
                
                // R√©initialiser
                deferredPrompt = null;
                installBtn.disabled = true;
                installBtn.textContent = 'üì± Installer l\'app';
                
            } catch (error) {
                log(`‚ùå Erreur lors de l'installation: ${error.message}`);
                updateStatus('‚ùå Erreur d\'installation', 'error');
            }
        }
        
        // Initialisation
        window.addEventListener('load', () => {
            log('üöÄ Test PWA initialis√©');
            checkPWACriteria();
            
            // V√©rifier le service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration()
                    .then(registration => {
                        if (registration) {
                            log('‚úÖ Service Worker enregistr√©');
                        } else {
                            log('‚ö†Ô∏è Aucun Service Worker enregistr√©');
                        }
                    })
                    .catch(error => {
                        log(`‚ùå Erreur Service Worker: ${error.message}`);
                    });
            }
        });
        
        // Log des erreurs
        window.addEventListener('error', (e) => {
            log(`‚ùå Erreur: ${e.message}`, 'error');
        });
    </script>
</body>
</html>
